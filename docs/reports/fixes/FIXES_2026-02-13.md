# Fixes Applied â€” February 13, 2026

> Post-audit implementation addressing critical findings from the Alpha Intelligence Assessment.

---

## P0: Critical Math Fixes

### 1. Kelly Criterion â€” Variable Odds (`52da7fb`)

**File:** `config/scaling_phases.py`

**Bug:** Kelly formula assumed even-money payoffs (`f* = 2p - 1`). Prediction markets have variable payouts.

**Impact:** At 25Â¢ market price with 45% estimated probability:
- Old formula: `f* = 2(0.45) - 1 = -0.10` â†’ **refused a profitable bet**
- New formula: `f* = (3.0 Ã— 0.45 - 0.55) / 3.0 = 0.267` â†’ **correct 26.7% sizing**

**Fix:**
```python
# BEFORE
kelly = (2 * p - 1)  # Simplified for even odds

# AFTER
b = (1.0 - mp) / mp  # payout ratio (e.g., price=0.25 â†’ b=3.0)
kelly = (b * p - q) / b if b > 0 else 0
```

Added `market_price` parameter (default 0.50 for backward compat). Wired into `/phase/simulate` endpoint.

**Verified:** VPS returns `kelly_raw=0.2667, payout_ratio=3.0` for `p=0.45, mp=0.25`.

---

### 2. Sharpe Ratio â€” Bessel's Correction (`52da7fb`)

**File:** `signals/shadow_tracker.py`, line 481

**Bug:** Used population std dev (Ã·N) instead of sample std dev (Ã·N-1). Inflated Sharpe by 5-10% with small samples.

**Fix:**
```python
# BEFORE
std_pnl = (sum((p - mean_pnl) ** 2 for p in pnl_values) / len(pnl_values)) ** 0.5

# AFTER
std_pnl = (sum((p - mean_pnl) ** 2 for p in pnl_values) / (len(pnl_values) - 1)) ** 0.5
```

---

### 3. SQLite PRAGMA busy_timeout (`52da7fb`)

**File:** `signals/alpha_score_tracker.py`

**Bug:** Raw `sqlite3.connect()` calls without `PRAGMA busy_timeout`. Under concurrent access (watchdog + API), causes immediate `SQLITE_BUSY` errors.

**Fix:** Added `_get_conn()` helper with WAL mode and 5-second busy timeout. Replaced all 5 raw connection calls.

```python
def _get_conn(db_path: str = None) -> sqlite3.Connection:
    conn = sqlite3.connect(db_path or str(DB_PATH), timeout=10)
    conn.execute("PRAGMA journal_mode=WAL")
    conn.execute("PRAGMA busy_timeout=5000")
    return conn
```

---

## P0.5: Signal Direction Fix

### 4. Side Logic â€” Fade the Market (`7dd1405`)

**File:** `signals/mispriced_category_signal.py`, lines 508 and 611

**Bug:** Side was determined by price level: `price >= 50 â†’ YES`. This bets WITH the crowd. In mispriced categories, the edge comes from betting AGAINST the crowd (fading).

**Impact:** Generated contradictory shadow trades â€” same market had both YES and NO entries when price oscillated around 50Â¢. Three conflicting pairs found:
- BTC above $68K: NO @ 42Â¢ (09:15) then YES @ 85Â¢ (15:15)
- BTC Up/Down Feb 14: YES @ 52Â¢ (08:30) then NO @ 49.5Â¢ (16:35)
- ETH Up/Down Feb 14: NO @ 42.5Â¢ (16:30) then YES @ 53.5Â¢ (16:35)

**Fix â€” Kalshi (line 508):**
```python
# BEFORE
side = "YES" if price >= 50 else "NO"

# AFTER â€” fade the market
if 45 <= price <= 55:
    continue  # too close to 50/50, no directional edge
side = "NO" if price > 50 else "YES"
fair_value = (price / 100.0) - category_edge if price > 50 else (price / 100.0) + category_edge
```

**Fix â€” Polymarket (line 611):**
```python
# BEFORE
side = "YES" if price_cents >= 50 else "NO"

# AFTER â€” fade the market
if 45 <= price_cents <= 55:
    continue  # too close to 50/50, no directional edge
side = "NO" if price_cents > 50 else "YES"
fair_value = yes_price - edge if price_cents > 50 else yes_price + edge
```

**Rationale:** The backtest (155K trades, 75% WR) profits by exploiting categories where markets systematically overprice. In a category with 25% error, if the market says 80Â¢ YES, the true probability is closer to 55-60Â¢ â€” so the edge is on NO. The old code would have bet YES at 80Â¢.

---

### 5. Shadow Trade Dedup â€” Per Market (`7dd1405`)

**File:** `signals/shadow_tracker.py`

**Bug:** UNIQUE constraint was `(market_id, side, snapshot_date)` â€” allowed both YES and NO for the same market on the same day. Dedup check was `WHERE market_id = ? AND side = ?` â€” only prevented same-side duplicates.

**Fix:**
```python
# BEFORE â€” only checks same market + same side
existing = conn.execute(
    "SELECT id, confidence FROM shadow_trades WHERE market_id = ? AND side = ? AND resolved = 0",
    (market_id, side)
).fetchone()

# AFTER â€” checks same market, ANY side
existing = conn.execute(
    "SELECT id, side, confidence FROM shadow_trades WHERE market_id = ? AND resolved = 0",
    (market_id,)
).fetchone()
```

**Side-flip rejection:** If an open trade exists and the new signal has the opposite side, the update is rejected with a warning log:
```python
if existing_side != side:
    logger.warning(f"Shadow trade side conflict: {market_id} was {existing_side}, now {side}")
    return False  # keep original, skip flip
```

**UNIQUE constraint updated:** `(market_id, snapshot_date)` â€” one trade per market per day.

**Data cleanup:** Deleted 3 conflicting entries (kept earlier trade in each pair). 8 clean trades remaining.

---

## Strategy 1: Score Velocity Modifier (`52da7fb`)

**Files:** `signals/alpha_score_tracker.py`, `signals/mispriced_category_signal.py`

**What:** Maps Virtuoso confluence score deltas to a confidence multiplier (0.7xâ€“1.3x).

**Implementation:**
- `score_velocity_modifier(symbol, hours=2)` in `alpha_score_tracker.py`
- `CATEGORY_CRYPTO_MAP` in `mispriced_category_signal.py` â€” maps categories to crypto symbols
- Applied in `calculate_signal_confidence()` BEFORE `min(95)` clamp
- Graceful degradation: try/except wraps the call, falls back to 1.0x

**Mapping:**
| Category | Symbol |
|----------|--------|
| tech, dynamic, KXCRYPTO, KXETF, KXSTONKS | BTCUSDT |
| ethereum | ETHUSDT |
| solana | SOLUSDT |

---

## IC Measurement Infrastructure (`52da7fb`)

**File:** `signals/ic_tracker.py` (NEW â€” 10,172 bytes)

**What:** Information Coefficient tracking to measure which signal sources carry real alpha.

**Components:**
- `record_signal_prediction()` â€” stores predictions at signal generation time
- `resolve_prediction()` / `resolve_from_shadow_trades()` â€” marks outcomes
- `calculate_ic()` â€” Spearman rank correlation per source
- `ic_report()` â€” aggregate IC with classification

**Thresholds:**
| IC | Classification | Action |
|----|---------------|--------|
| < 0.03 | KILL | Source adds noise, remove |
| < 0.05 | WARN | Marginal, needs more data |
| â‰¥ 0.05 | OK | Contributing alpha |

**API Endpoints:**
- `GET /api/signals/ic-report` â€” aggregate report
- `GET /api/signals/ic/{source}` â€” per-source detail

**Status:** 16 predictions recorded on first day. Need ~200 resolved for meaningful IC calculation.

---

## Test Coverage

| Suite | Tests | Status |
|-------|-------|--------|
| `test_p0_fixes.py` | 10 | âœ… All passing |
| `test_velocity_modifier.py` | 9 | âœ… All passing |
| `test_ic_tracker.py` | 15 | âœ… All passing |
| Existing tests | 71 | âœ… Zero regressions |
| **Total** | **105** | **âœ… All passing** |

---

## Commits

| Hash | Description |
|------|-------------|
| `52da7fb` | P0 fixes + Strategy 1 velocity + IC tracker |
| `7dd1405` | Side logic fix + shadow trade dedup |

---

## Remaining from Audit

| # | Item | Status |
|---|------|--------|
| ~~Kelly variable odds~~ | âœ… Fixed |
| ~~Sharpe Bessel's correction~~ | âœ… Fixed |
| ~~PRAGMA busy_timeout~~ | âœ… Fixed |
| ~~Side logic (fade market)~~ | âœ… Fixed |
| ~~Shadow trade dedup~~ | âœ… Fixed |
| ~~Score velocity modifier~~ | âœ… Deployed |
| ~~IC measurement infrastructure~~ | âœ… Recording |
| Bayesian confidence clamp to [0, 0.95] | âœ… Already clamped (`min(95, confidence)`) |
| Staleness detection for data sources | ðŸ”² P1 |
| Per-strategy allocation limits | ðŸ”² P1 |
| Directional exposure limits | ðŸ”² P1 |
| Vol scaling sqrt(T) for Strategy 2 | ðŸ”² P1 (not yet built) |
| Walk-forward validation (3+ months) | ðŸ”² P2 |
| Fill probability model | ðŸ”² P2 |
| Database split (market_data.db) | ðŸ”² P3 |
| Data retention policy | ðŸ”² P3 |
