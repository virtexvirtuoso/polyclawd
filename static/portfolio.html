<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Polyclawd ‚Äî Paper Portfolio</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap');
  :root {
    --bg:#0a0a0f;--surface:#12121a;--surface2:#1a1a26;--border:#2a2a3a;
    --accent:#6c5ce7;--accent2:#a29bfe;--green:#00e676;--red:#ff5252;
    --orange:#ffab40;--cyan:#18ffff;--text:#e8e8f0;--text2:#8888a0;--gold:#ffd700;
  }
  *{margin:0;padding:0;box-sizing:border-box}
  body{background:var(--bg);color:var(--text);font-family:'Inter',-apple-system,sans-serif;min-height:100vh}
  .noise{position:fixed;top:0;left:0;width:100%;height:100%;background:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");pointer-events:none;z-index:0}
  .container{max-width:1200px;margin:0 auto;padding:40px 24px;position:relative;z-index:1}

  /* Header */
  header{text-align:center;margin-bottom:48px;position:relative}
  header::before{content:'';position:absolute;top:-100px;left:50%;transform:translateX(-50%);width:600px;height:600px;background:radial-gradient(circle,rgba(108,92,231,0.08) 0%,transparent 70%);pointer-events:none}
  .logo{font-size:13px;letter-spacing:6px;text-transform:uppercase;color:var(--accent2);margin-bottom:16px;font-weight:500}
  .logo span{color:var(--gold)}
  h1{font-size:42px;font-weight:700;letter-spacing:-1px;background:linear-gradient(135deg,var(--text) 0%,var(--accent2) 50%,var(--cyan) 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:12px}
  .subtitle{color:var(--text2);font-size:15px;font-weight:300}
  .subtitle strong{color:var(--green);font-weight:500}
  .timestamp{display:inline-block;margin-top:16px;padding:6px 16px;background:var(--surface);border:1px solid var(--border);border-radius:20px;font-family:'JetBrains Mono',monospace;font-size:12px;color:var(--text2)}
  .live-dot{display:inline-block;width:8px;height:8px;border-radius:50%;background:var(--green);margin-right:6px;animation:pulse 2s infinite}
  @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}

  /* Controls */
  .controls{display:flex;gap:12px;align-items:center;justify-content:center;margin-bottom:40px}
  .btn{padding:10px 24px;border-radius:10px;border:1px solid var(--border);cursor:pointer;font-family:'Inter',sans-serif;font-weight:600;font-size:13px;transition:all 0.25s;display:inline-flex;align-items:center;gap:8px}
  .btn-primary{background:linear-gradient(135deg,var(--accent),#7c3aed);border-color:var(--accent);color:#fff}
  .btn-primary:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(108,92,231,0.3)}
  .btn-secondary{background:var(--surface);color:var(--text2)}
  .btn-secondary:hover{border-color:var(--accent);color:var(--text)}
  .btn:disabled{opacity:0.4;cursor:not-allowed;transform:none}
  .status-msg{font-family:'JetBrains Mono',monospace;font-size:12px;color:var(--text2)}

  /* Stats Row */
  .stats-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(170px,1fr));gap:14px;margin-bottom:48px}
  .stat-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:18px 20px;position:relative;overflow:hidden;transition:border-color 0.3s}
  .stat-card:hover{border-color:var(--accent)}
  .stat-card::after{content:'';position:absolute;top:0;left:0;right:0;height:2px}
  .stat-card.bankroll::after{background:linear-gradient(90deg,var(--accent),var(--cyan))}
  .stat-card.pnl-pos::after{background:var(--green)}
  .stat-card.pnl-neg::after{background:var(--red)}
  .stat-card.wr::after{background:var(--gold)}
  .stat-card.sharpe::after{background:var(--accent2)}
  .stat-card.dd::after{background:var(--orange)}
  .stat-card.trades::after{background:var(--cyan)}
  .stat-card.hold::after{background:var(--accent2)}
  .stat-card.unreal::after{background:linear-gradient(90deg,var(--green),var(--orange))}
  .stat-card.risk::after{background:var(--red)}
  .stat-label{font-size:10px;text-transform:uppercase;letter-spacing:2px;color:var(--text2);margin-bottom:6px}
  .stat-value{font-size:24px;font-weight:700;font-family:'JetBrains Mono',monospace}
  .stat-sub{font-size:11px;color:var(--text2);margin-top:4px}
  .green{color:var(--green)}.red{color:var(--red)}.gold{color:var(--gold)}.cyan{color:var(--cyan)}.accent{color:var(--accent2)}.orange{color:var(--orange)}

  /* Section Cards */
  .section-card{background:var(--surface);border:1px solid var(--border);border-radius:16px;margin-bottom:32px;overflow:hidden;transition:border-color 0.3s}
  .section-card:hover{border-color:var(--accent)}
  .section-header{display:flex;align-items:center;justify-content:space-between;padding:20px 28px;border-bottom:1px solid var(--border);background:var(--surface2)}
  .section-title{display:flex;align-items:center;gap:12px}
  .section-icon{display:inline-flex;align-items:center;justify-content:center;width:30px;height:30px;border-radius:8px;font-size:14px}
  .section-icon.positions{background:rgba(0,230,118,0.15)}
  .section-icon.signals{background:rgba(108,92,231,0.15)}
  .section-icon.history{background:rgba(24,255,255,0.15)}
  .section-icon.equity{background:rgba(255,215,0,0.15)}
  .section-title h2{font-size:18px;font-weight:600}
  .section-count{font-family:'JetBrains Mono',monospace;font-size:12px;color:var(--text2);padding:4px 12px;background:var(--surface);border:1px solid var(--border);border-radius:20px}
  .section-body{padding:24px 28px}

  /* Positions Grid */
  .positions-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(340px,1fr));gap:14px}
  .pos-card{background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:18px 20px;position:relative;overflow:hidden;transition:all 0.3s}
  .pos-card:hover{border-color:var(--accent);transform:translateY(-2px)}
  .pos-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px}
  .pos-card.yes::before{background:var(--green)}
  .pos-card.no::before{background:var(--red)}
  .pos-top{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:14px}
  .pos-market{font-size:14px;font-weight:500;line-height:1.4;flex:1;margin-right:12px}
  .badge{padding:3px 10px;border-radius:6px;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;white-space:nowrap}
  .badge-yes{background:rgba(0,230,118,0.15);color:var(--green);border:1px solid rgba(0,230,118,0.3)}
  .badge-no{background:rgba(255,82,82,0.15);color:var(--red);border:1px solid rgba(255,82,82,0.3)}
  .pos-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  .pos-stat{background:var(--surface);border-radius:8px;padding:8px 10px}
  .pos-stat-label{font-size:9px;text-transform:uppercase;letter-spacing:1.5px;color:var(--text2);margin-bottom:2px}
  .pos-stat-value{font-size:14px;font-weight:600;font-family:'JetBrains Mono',monospace}
  .pos-platform{margin-top:12px;display:flex;justify-content:space-between;align-items:center}
  .platform-tag{font-size:10px;text-transform:uppercase;letter-spacing:1.5px;color:var(--text2);padding:3px 8px;background:var(--surface);border-radius:4px}
  .pos-days{font-size:11px;color:var(--text2);font-family:'JetBrains Mono',monospace}

  /* Signals */
  .signal-row{display:flex;align-items:center;padding:12px 0;border-bottom:1px solid rgba(42,42,58,0.5);gap:12px}
  .signal-row:last-child{border:none}
  .signal-market{flex:1;font-size:13px;font-weight:500}
  .signal-edge{font-family:'JetBrains Mono',monospace;font-size:12px;padding:3px 10px;border-radius:6px;white-space:nowrap}
  .signal-edge.good{background:rgba(0,230,118,0.1);color:var(--green)}
  .signal-edge.low{background:rgba(136,136,160,0.1);color:var(--text2)}
  .signal-action{font-size:12px;font-weight:600;padding:4px 12px;border-radius:6px;white-space:nowrap}
  .signal-action.opened{background:rgba(0,230,118,0.12);color:var(--green)}
  .signal-action.skipped{background:rgba(136,136,160,0.08);color:var(--text2)}

  /* History Table */
  table{width:100%;border-collapse:collapse}
  th{text-align:left;font-size:10px;text-transform:uppercase;letter-spacing:1.5px;color:var(--text2);padding:10px 14px;border-bottom:1px solid var(--border);font-weight:500}
  td{padding:12px 14px;border-bottom:1px solid rgba(42,42,58,0.3);font-size:13px}
  tr:hover td{background:rgba(108,92,231,0.03)}
  .mono{font-family:'JetBrains Mono',monospace}
  .result-won{color:var(--green);font-weight:600}
  .result-lost{color:var(--red);font-weight:600}

  /* Chart */
  .chart-container{height:280px;position:relative}

  /* Empty state */
  .empty{color:var(--text2);text-align:center;padding:40px;font-size:14px}
  .empty-icon{font-size:32px;margin-bottom:12px;opacity:0.5}

  /* Footer */
  footer{text-align:center;padding:40px 0 20px;border-top:1px solid var(--border);margin-top:20px}
  footer p{font-size:12px;color:var(--text2);font-family:'JetBrains Mono',monospace}
  footer .brand{color:var(--accent2)}

  /* Nav link */
  .nav-link{display:inline-block;font-size:12px;color:var(--text2);text-decoration:none;padding:8px 16px;border:1px solid var(--border);border-radius:8px;transition:all 0.2s;margin-bottom:16px}
  .nav-link:hover{border-color:var(--accent);color:var(--accent2)}

  /* Market link */
  .market-link{color:var(--text);text-decoration:none;transition:color 0.2s}
  .market-link:hover{color:var(--accent2);text-decoration:underline}

  /* Stale position warning */
  .pos-card.stale{border-color:var(--orange)}
  .pos-card.stale::after{content:'STALE';position:absolute;top:8px;right:8px;font-size:9px;font-weight:700;letter-spacing:1px;color:var(--orange);background:rgba(255,171,64,0.12);padding:2px 8px;border-radius:4px}
  .unrealized{font-size:12px;font-weight:600;font-family:'JetBrains Mono',monospace;margin-top:8px;padding:4px 8px;border-radius:6px;display:inline-block}
  .unrealized.up{background:rgba(0,230,118,0.1);color:var(--green)}
  .unrealized.down{background:rgba(255,82,82,0.1);color:var(--red)}

  /* Archetype table */
  .arch-table{width:100%;border-collapse:collapse}
  .arch-table th{text-align:left;font-size:10px;text-transform:uppercase;letter-spacing:1.5px;color:var(--text2);padding:10px 12px;border-bottom:1px solid var(--border)}
  .arch-table td{padding:10px 12px;border-bottom:1px solid rgba(42,42,58,0.3);font-size:13px}
  .arch-table .arch-name{font-weight:600;color:var(--accent2)}
  .arch-bar{height:4px;border-radius:2px;background:var(--border);min-width:40px;position:relative;overflow:hidden}
  .arch-bar-fill{height:100%;border-radius:2px;transition:width 0.5s}

  /* Sparkline canvas */
  .arch-spark{width:80px;height:24px}

  /* Manual close buttons */
  .pos-actions{display:flex;gap:6px;margin-top:10px}
  .pos-btn{padding:4px 10px;border-radius:6px;border:1px solid var(--border);background:var(--surface);cursor:pointer;font-size:11px;font-weight:600;font-family:'Inter',sans-serif;transition:all 0.2s}
  .pos-btn:hover{transform:translateY(-1px)}
  .pos-btn.won{color:var(--green);border-color:rgba(0,230,118,0.3)}
  .pos-btn.won:hover{background:rgba(0,230,118,0.1)}
  .pos-btn.lost{color:var(--red);border-color:rgba(255,82,82,0.3)}
  .pos-btn.lost:hover{background:rgba(255,82,82,0.1)}

  /* Risk exposure bar */
  .risk-bar{display:flex;align-items:center;gap:12px;padding:14px 0;margin-bottom:8px}
  .risk-bar-visual{flex:1;height:8px;border-radius:4px;background:var(--surface2);overflow:hidden;position:relative}
  .risk-bar-fill{height:100%;border-radius:4px;transition:width 0.5s}
  .risk-labels{display:flex;justify-content:space-between;font-size:11px;color:var(--text2);font-family:'JetBrains Mono',monospace}
  .capacity-badge{font-size:10px;font-weight:700;letter-spacing:1px;padding:3px 10px;border-radius:6px;display:inline-block}
  .capacity-badge.full{background:rgba(255,82,82,0.15);color:var(--red);border:1px solid rgba(255,82,82,0.3)}
  .capacity-badge.ok{background:rgba(0,230,118,0.1);color:var(--green);border:1px solid rgba(0,230,118,0.2)}

  /* Resolve log */
  .resolve-row{display:flex;align-items:center;padding:8px 0;border-bottom:1px solid rgba(42,42,58,0.3);gap:10px;font-size:12px}
  .resolve-row:last-child{border:none}
  .resolve-time{font-family:'JetBrains Mono',monospace;color:var(--text2);white-space:nowrap;font-size:11px}
  .resolve-market{flex:1;font-weight:500}

  @media(max-width:768px){
    h1{font-size:28px}
    .stats-row{grid-template-columns:repeat(2,1fr)}
    .positions-grid{grid-template-columns:1fr}
    .controls{flex-wrap:wrap;justify-content:center}
    .section-body{padding:16px}
  }
</style>
</head>
<body>
<div class="noise"></div>
<div class="container">

<nav style="text-align:right;padding:16px 24px 0"><a href="analysis.html" class="nav-link">‚Üê Analysis Suite</a></nav>
<header>
  <div class="logo">Virtuoso Crypto ‚Äî <span>Polyclawd</span></div>
  <h1>Paper Portfolio</h1>
  <p class="subtitle">Prediction market paper trading ¬∑ <strong>1/8 Kelly</strong> ¬∑ $500 bankroll ¬∑ 10 max positions</p>
  <div class="timestamp"><span class="live-dot"></span>live ¬∑ auto-refresh 60s ¬∑ <span id="lastUpdate">‚Äî</span></div>
</header>

<div class="controls">
  <button class="btn btn-primary" id="processBtn" onclick="processSignals()">‚ö° Process Signals</button>
  <button class="btn btn-secondary" onclick="loadAll()">‚Üª Refresh</button>
  <span class="status-msg" id="statusMsg"></span>
</div>

<div class="stats-row">
  <div class="stat-card bankroll">
    <div class="stat-label">Bankroll</div>
    <div class="stat-value cyan" id="bankroll">$500.00</div>
    <div class="stat-sub" id="bankrollSub">starting capital</div>
  </div>
  <div class="stat-card pnl-pos" id="pnlCard">
    <div class="stat-label">Total P&L</div>
    <div class="stat-value" id="totalPnl">$0.00</div>
    <div class="stat-sub" id="pnlSub">0 trades resolved</div>
  </div>
  <div class="stat-card wr">
    <div class="stat-label">Win Rate</div>
    <div class="stat-value gold" id="winRate">‚Äî</div>
    <div class="stat-sub" id="wrSub">wins / losses</div>
  </div>
  <div class="stat-card sharpe">
    <div class="stat-label">Sharpe Estimate</div>
    <div class="stat-value accent" id="sharpe">‚Äî</div>
    <div class="stat-sub">risk-adjusted return</div>
  </div>
  <div class="stat-card dd">
    <div class="stat-label">Max Drawdown</div>
    <div class="stat-value orange" id="maxDD">0%</div>
    <div class="stat-sub" id="ddSub">from peak bankroll</div>
  </div>
  <div class="stat-card trades">
    <div class="stat-label">Positions</div>
    <div class="stat-value cyan" id="tradeCount">0 / 0</div>
    <div class="stat-sub">open / total</div>
  </div>
  <div class="stat-card unreal" id="unrealCard">
    <div class="stat-label">Unrealized P&L</div>
    <div class="stat-value" id="unrealPnl">‚Äî</div>
    <div class="stat-sub" id="unrealSub">open position value</div>
  </div>
  <div class="stat-card hold">
    <div class="stat-label">Avg Hold Time</div>
    <div class="stat-value accent" id="avgHold">‚Äî</div>
    <div class="stat-sub">days to resolution</div>
  </div>
  <div class="stat-card risk">
    <div class="stat-label">Capital at Risk</div>
    <div class="stat-value red" id="capitalRisk">$0</div>
    <div class="stat-sub" id="riskSub">of $500 bankroll</div>
  </div>
</div>

<!-- Risk Exposure -->
<div id="riskExposure" style="margin-bottom:32px"></div>

<!-- Open Positions -->
<div class="section-card">
  <div class="section-header">
    <div class="section-title">
      <span class="section-icon positions">üìà</span>
      <h2>Open Positions</h2>
    </div>
    <span class="section-count" id="openCount">0 open</span>
  </div>
  <div class="section-body">
    <div class="positions-grid" id="openPositions">
      <div class="empty"><div class="empty-icon">üì≠</div>No open positions ‚Äî process signals to start trading</div>
    </div>
  </div>
</div>

<!-- Recent Signals -->
<div class="section-card">
  <div class="section-header">
    <div class="section-title">
      <span class="section-icon signals">üéØ</span>
      <h2>Recent Signals</h2>
    </div>
    <span class="section-count" id="signalCount">‚Äî</span>
  </div>
  <div class="section-body" id="recentSignals">
    <div class="empty"><div class="empty-icon">üì°</div>Process signals to see evaluation results</div>
  </div>
</div>

<!-- Trade History -->
<div class="section-card">
  <div class="section-header">
    <div class="section-title">
      <span class="section-icon history">üìã</span>
      <h2>Trade History</h2>
    </div>
    <span class="section-count" id="historyCount">0 trades</span>
  </div>
  <div class="section-body" id="tradeHistory">
    <div class="empty"><div class="empty-icon">‚è≥</div>No closed trades yet ‚Äî waiting for market resolutions</div>
  </div>
</div>

<!-- Equity Curve -->
<div class="section-card">
  <div class="section-header">
    <div class="section-title">
      <span class="section-icon equity">üìâ</span>
      <h2>Equity Curve</h2>
    </div>
  </div>
  <div class="section-body">
    <div class="chart-container"><canvas id="equityChart"></canvas></div>
  </div>
</div>

<!-- Archetype Breakdown -->
<div class="section-card">
  <div class="section-header">
    <div class="section-title">
      <span class="section-icon signals">üß¨</span>
      <h2>Archetype Breakdown</h2>
    </div>
    <span class="section-count" id="archCount">‚Äî</span>
  </div>
  <div class="section-body" id="archetypeBreakdown">
    <div class="empty"><div class="empty-icon">üß¨</div>No resolved trades yet ‚Äî breakdown appears after positions close</div>
  </div>
</div>

<!-- Resolve Log -->
<div class="section-card">
  <div class="section-header">
    <div class="section-title">
      <span class="section-icon history">üîÑ</span>
      <h2>Resolve Log</h2>
    </div>
    <span class="section-count" id="resolveCount">‚Äî</span>
  </div>
  <div class="section-body" id="resolveLog">
    <div class="empty"><div class="empty-icon">üîÑ</div>No resolutions yet</div>
  </div>
</div>

<footer>
  <p><span class="brand">Polyclawd</span> ¬∑ paper portfolio ¬∑ 1/8 Kelly ¬∑ prediction market edge trading</p>
  <p style="margin-top:8px;font-size:11px;color:#555">Not financial advice ¬∑ For research purposes only</p>
</footer>

</div>

<script>
const API = '/polyclawd/api';
let equityChart = null;
let cachedUnrealizedPnl = 0;

function marketUrl(p) {
  const id = p.market_id || p.id || '';
  const plat = (p.platform || '').toLowerCase();
  if (plat === 'kalshi' || (!plat && !id.startsWith('0x'))) {
    return id ? `https://kalshi.com/markets/${id}` : '';
  }
  // Use market_slug for working Polymarket links (/market/<slug> -> 307 redirect)
  const slug = p.market_slug || '';
  if (slug) return `https://polymarket.com/market/${slug}`;
  return id ? `https://polymarket.com/markets/${id}` : '';
}

async function loadAll() {
  try {
    // Auto-resolve stale positions first (fire-and-forget)
    fetch(`${API}/portfolio/resolve`, { method: 'POST' }).catch(() => {});

    const [statusRes, liveRes, histRes, archRes, archPnlRes, resolveLogRes] = await Promise.all([
      fetch(`${API}/portfolio/status`).then(r => r.json()).catch(() => ({})),
      fetch(`${API}/portfolio/positions-live`).then(r => r.json()).catch(() => null),
      fetch(`${API}/portfolio/history?limit=50`).then(r => r.json()).catch(() => []),
      fetch(`${API}/portfolio/archetype-breakdown`).then(r => r.json()).catch(() => null),
      fetch(`${API}/portfolio/archetype-pnl-series`).then(r => r.json()).catch(() => null),
      fetch(`${API}/portfolio/resolve-log?limit=15`).then(r => r.json()).catch(() => []),
    ]);

    renderStatus(statusRes, archRes);
    renderRiskExposure(statusRes);
    const positions = liveRes ? liveRes.positions : (statusRes.positions || []);
    renderPositions(positions);
    if (liveRes) renderUnrealizedPnl(liveRes);
    renderHistory(histRes, liveRes);
    if (archRes) renderArchetypeBreakdown(archRes, archPnlRes);
    renderResolveLog(resolveLogRes);
    document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
  } catch(e) {
    console.error('Load failed:', e);
    document.getElementById('statusMsg').textContent = '‚ö†Ô∏è API unreachable';
  }
}

function renderStatus(s, archRes) {
  const bankroll = s.bankroll || 500;
  document.getElementById('bankroll').textContent = `$${bankroll.toFixed(2)}`;
  const returnPct = ((bankroll - 500) / 500 * 100).toFixed(1);
  document.getElementById('bankrollSub').textContent = bankroll !== 500 ? `${returnPct > 0 ? '+' : ''}${returnPct}% return` : 'starting capital';

  const pnl = s.total_pnl || 0;
  const pnlEl = document.getElementById('totalPnl');
  pnlEl.textContent = `${pnl >= 0 ? '+' : ''}$${pnl.toFixed(2)}`;
  pnlEl.className = `stat-value ${pnl >= 0 ? 'green' : 'red'}`;
  const pnlCard = document.getElementById('pnlCard');
  pnlCard.className = `stat-card ${pnl >= 0 ? 'pnl-pos' : 'pnl-neg'}`;
  const totalTrades = (s.wins || 0) + (s.losses || 0);
  document.getElementById('pnlSub').textContent = `${totalTrades} trade${totalTrades !== 1 ? 's' : ''} resolved`;

  const wr = s.win_rate || 0;
  document.getElementById('winRate').textContent = totalTrades > 0 ? `${wr}%` : '‚Äî';
  document.getElementById('wrSub').textContent = `${s.wins || 0}W / ${s.losses || 0}L`;

  const sharpe = s.sharpe_estimate || 0;
  document.getElementById('sharpe').textContent = totalTrades >= 3 ? sharpe.toFixed(2) : '‚Äî';

  const dd = s.max_drawdown || 0;
  document.getElementById('maxDD').textContent = `${dd.toFixed(1)}%`;

  const open = s.open_positions || 0;
  const total = s.total_trades || 0;
  document.getElementById('tradeCount').textContent = `${open} / ${total}`;
  document.getElementById('openCount').textContent = `${open} open`;

  // Average hold time from archetype breakdown
  const avgHold = archRes ? archRes.avg_hold_days : 0;
  document.getElementById('avgHold').textContent = avgHold > 0 ? `${avgHold}d` : '‚Äî';

  // Capital at risk
  const car = s.capital_at_risk || 0;
  document.getElementById('capitalRisk').textContent = `$${car.toFixed(0)}`;
  const bankPct = bankroll > 0 ? (car / bankroll * 100).toFixed(0) : 0;
  document.getElementById('riskSub').textContent = `${bankPct}% of bankroll`;
}

function renderRiskExposure(s) {
  const el = document.getElementById('riskExposure');
  const car = s.capital_at_risk || 0;
  const maxLoss = s.max_loss || 0;
  const maxGain = s.max_gain || 0;
  const bankroll = s.bankroll || 500;
  const open = s.open_positions || 0;
  const maxPos = s.max_positions || 10;
  const isFull = open >= maxPos;
  const riskPct = bankroll > 0 ? Math.min(100, car / bankroll * 100) : 0;

  el.innerHTML = `<div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:18px 24px">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <span style="font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:1.5px;color:var(--text2)">Risk Exposure</span>
      <span class="capacity-badge ${isFull ? 'full' : 'ok'}">${open}/${maxPos} SLOTS${isFull ? ' ‚Äî FULL' : ''}</span>
    </div>
    <div class="risk-bar-visual">
      <div class="risk-bar-fill" style="width:${riskPct}%;background:${riskPct > 60 ? 'var(--red)' : riskPct > 30 ? 'var(--orange)' : 'var(--green)'}"></div>
    </div>
    <div class="risk-labels" style="margin-top:8px">
      <span>Max loss: <span class="red">${maxLoss >= 0 ? '+' : ''}$${maxLoss.toFixed(2)}</span></span>
      <span>At risk: <span style="color:var(--text)">$${car.toFixed(2)}</span> (${riskPct.toFixed(0)}%)</span>
      <span>Max gain: <span class="green">+$${maxGain.toFixed(2)}</span></span>
    </div>
  </div>`;
}

function renderUnrealizedPnl(liveRes) {
  const unreal = liveRes.total_unrealized_pnl || 0;
  cachedUnrealizedPnl = unreal;
  const el = document.getElementById('unrealPnl');
  el.textContent = `${unreal >= 0 ? '+' : ''}$${unreal.toFixed(2)}`;
  el.className = `stat-value ${unreal >= 0 ? 'green' : 'red'}`;
  const count = (liveRes.positions || []).filter(p => p.unrealized_pnl !== null).length;
  document.getElementById('unrealSub').textContent = `${count} position${count !== 1 ? 's' : ''} priced`;
}

function renderPositions(positions) {
  const el = document.getElementById('openPositions');
  if (!positions.length) {
    el.innerHTML = '<div class="empty"><div class="empty-icon">üì≠</div>No open positions ‚Äî process signals to start trading</div>';
    return;
  }
  el.innerHTML = positions.map(p => {
    const days = p.hold_days != null ? p.hold_days : Math.max(0, Math.floor((Date.now() - new Date(p.opened_at).getTime()) / 86400000));
    const isStale = p.stale || days >= 3;
    const sideClass = (p.side || '').toLowerCase();
    const payout = p.potential_payout || 0;
    const roi = p.bet_size ? ((payout / p.bet_size - 1) * 100).toFixed(0) : '0';
    const unreal = p.unrealized_pnl;
    const unrealHtml = unreal != null
      ? `<div class="unrealized ${unreal >= 0 ? 'up' : 'down'}">${unreal >= 0 ? '+' : ''}$${unreal.toFixed(2)} unrealized</div>`
      : '';
    const currentPriceHtml = p.current_price != null
      ? `<div class="pos-stat"><div class="pos-stat-label">Now</div><div class="pos-stat-value">${(p.current_price * 100).toFixed(0)}¬¢</div></div>`
      : '';
    const mUrl = marketUrl(p);
    const titleText = (p.market_title || '').substring(0, 80);
    const titleHtml = mUrl ? `<a href="${mUrl}" target="_blank" rel="noopener" class="market-link">${titleText} ‚Üó</a>` : titleText;
    return `<div class="pos-card ${sideClass}${isStale ? ' stale' : ''}">
      <div class="pos-top">
        <div class="pos-market">${titleHtml}</div>
        <span class="badge badge-${sideClass}">${p.side}</span>
      </div>
      <div class="pos-grid">
        <div class="pos-stat">
          <div class="pos-stat-label">Entry</div>
          <div class="pos-stat-value">${((p.entry_price || 0) * 100).toFixed(0)}¬¢</div>
        </div>
        ${currentPriceHtml}
        <div class="pos-stat">
          <div class="pos-stat-label">Bet Size</div>
          <div class="pos-stat-value">$${(p.bet_size || 0).toFixed(2)}</div>
        </div>
        <div class="pos-stat">
          <div class="pos-stat-label">Payout</div>
          <div class="pos-stat-value green">$${payout.toFixed(2)}</div>
        </div>
        <div class="pos-stat">
          <div class="pos-stat-label">Confidence</div>
          <div class="pos-stat-value">${((p.confidence || 0) * 100).toFixed(0)}%</div>
        </div>
        <div class="pos-stat">
          <div class="pos-stat-label">Edge</div>
          <div class="pos-stat-value green">${((p.edge_pct || 0) * 100).toFixed(1)}%</div>
        </div>
      </div>
      ${unrealHtml}
      <div class="pos-platform">
        <span class="platform-tag">${(p.platform || 'polymarket').toUpperCase()}</span>
        <span class="pos-days${isStale ? ' orange' : ''}">${days}d open</span>
      </div>
      <div class="pos-actions">
        <button class="pos-btn won" onclick="manualClose(${p.id},'won',this)">Mark Won</button>
        <button class="pos-btn lost" onclick="manualClose(${p.id},'lost',this)">Mark Lost</button>
      </div>
    </div>`;
  }).join('');
}

async function manualClose(id, outcome, btn) {
  if (!confirm(`Mark position #${id} as ${outcome}?`)) return;
  btn.disabled = true;
  btn.textContent = '...';
  try {
    const res = await fetch(`${API}/portfolio/close/${id}?outcome=${outcome}`, { method: 'POST' }).then(r => r.json());
    if (res.closed) {
      document.getElementById('statusMsg').textContent = `${outcome === 'won' ? '‚úÖ' : '‚ùå'} ${res.market} ‚Üí ${outcome} (${res.pnl >= 0 ? '+' : ''}$${res.pnl.toFixed(2)})`;
      setTimeout(loadAll, 300);
    } else {
      alert(res.reason || 'Failed to close');
      btn.disabled = false;
      btn.textContent = outcome === 'won' ? 'Mark Won' : 'Mark Lost';
    }
  } catch(e) {
    alert('Error: ' + e.message);
    btn.disabled = false;
    btn.textContent = outcome === 'won' ? 'Mark Won' : 'Mark Lost';
  }
}

function renderHistory(history, liveRes) {
  const el = document.getElementById('tradeHistory');
  const items = Array.isArray(history) ? history : (history.positions || []);
  document.getElementById('historyCount').textContent = `${items.length} trade${items.length !== 1 ? 's' : ''}`;
  if (!items.length) {
    el.innerHTML = '<div class="empty"><div class="empty-icon">‚è≥</div>No closed trades yet ‚Äî waiting for market resolutions</div>';
    updateEquityChart([], liveRes);
    return;
  }
  el.innerHTML = `<table>
    <thead><tr><th>Market</th><th>Side</th><th>Entry</th><th>Bet</th><th>P&L</th><th>Result</th></tr></thead>
    <tbody>${items.map(t => {
      const pnl = t.pnl || 0;
      const tUrl = marketUrl(t);
      const tTitle = (t.market_title || '').substring(0, 55);
      const tTitleHtml = tUrl ? `<a href="${tUrl}" target="_blank" rel="noopener" class="market-link">${tTitle} ‚Üó</a>` : tTitle;
      return `<tr>
        <td>${tTitleHtml}</td>
        <td><span class="badge badge-${(t.side||'').toLowerCase()}">${t.side}</span></td>
        <td class="mono">${((t.entry_price||0)*100).toFixed(0)}¬¢</td>
        <td class="mono">$${(t.bet_size||0).toFixed(2)}</td>
        <td class="mono ${pnl >= 0 ? 'result-won' : 'result-lost'}">${pnl >= 0 ? '+' : ''}$${pnl.toFixed(2)}</td>
        <td>${t.status === 'won' ? '‚úÖ Won' : '‚ùå Lost'}</td>
      </tr>`;
    }).join('')}</tbody>
  </table>`;
  updateEquityChart(items, liveRes);
}

function updateEquityChart(history, liveRes) {
  const sorted = [...history].reverse();
  let bankroll = 500;
  const labels = ['Start'];
  const data = [500];

  sorted.forEach((t, i) => {
    bankroll += (t.pnl || 0);
    const d = t.closed_at ? new Date(t.closed_at) : null;
    labels.push(d ? `${d.getMonth()+1}/${d.getDate()}` : `#${i + 1}`);
    data.push(Math.round(bankroll * 100) / 100);
  });

  // Add unrealized P&L as final dotted point
  const unrealData = [...data];
  const unrealLabels = [...labels];
  const totalUnreal = liveRes ? (liveRes.total_unrealized_pnl || 0) : 0;
  if (totalUnreal !== 0 && data.length > 1) {
    unrealLabels.push('now');
    unrealData.push(Math.round((bankroll + totalUnreal) * 100) / 100);
  }

  if (equityChart) equityChart.destroy();

  const ctx = document.getElementById('equityChart').getContext('2d');
  const gradient = ctx.createLinearGradient(0, 0, 0, 280);
  gradient.addColorStop(0, 'rgba(108,92,231,0.2)');
  gradient.addColorStop(1, 'rgba(108,92,231,0)');

  const datasets = [{
    label: 'Realized',
    data,
    borderColor: '#a29bfe',
    backgroundColor: gradient,
    fill: true,
    tension: 0.35,
    pointRadius: data.length > 20 ? 0 : 4,
    pointBackgroundColor: '#a29bfe',
    pointBorderColor: '#0a0a0f',
    pointBorderWidth: 2,
    borderWidth: 2,
  }];

  // Dotted unrealized line: from last realized point to projected point
  if (totalUnreal !== 0 && data.length > 1) {
    const unrealLine = new Array(data.length - 1).fill(null);
    unrealLine.push(data[data.length - 1]);
    unrealLine.push(Math.round((bankroll + totalUnreal) * 100) / 100);
    datasets.push({
      label: 'Unrealized',
      data: unrealLine,
      borderColor: totalUnreal >= 0 ? 'rgba(0,230,118,0.6)' : 'rgba(255,82,82,0.6)',
      borderDash: [6, 4],
      fill: false,
      tension: 0,
      pointRadius: [0, 6],
      pointBackgroundColor: totalUnreal >= 0 ? '#00e676' : '#ff5252',
      pointBorderColor: '#0a0a0f',
      pointBorderWidth: 2,
      borderWidth: 2,
    });
  }

  equityChart = new Chart(ctx, {
    type: 'line',
    data: { labels: totalUnreal !== 0 && data.length > 1 ? unrealLabels : labels, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: datasets.length > 1, labels: { color: '#8888a0', font: { size: 11 } } },
        tooltip: {
          backgroundColor: '#1a1a26',
          borderColor: '#2a2a3a',
          borderWidth: 1,
          titleFont: { family: 'JetBrains Mono' },
          bodyFont: { family: 'JetBrains Mono' },
          callbacks: {
            label: ctx => `$${ctx.parsed.y.toFixed(2)}`
          }
        }
      },
      scales: {
        x: {
          ticks: { color: '#8888a0', font: { size: 11, family: 'JetBrains Mono' } },
          grid: { color: 'rgba(42,42,58,0.3)' },
        },
        y: {
          ticks: {
            color: '#8888a0',
            font: { size: 11, family: 'JetBrains Mono' },
            callback: v => '$' + v
          },
          grid: { color: 'rgba(42,42,58,0.3)' },
        }
      }
    }
  });
}

function renderArchetypeBreakdown(archRes, archPnlRes) {
  const el = document.getElementById('archetypeBreakdown');
  const items = archRes.breakdown || [];
  document.getElementById('archCount').textContent = `${items.length} archetype${items.length !== 1 ? 's' : ''}`;
  if (!items.length) {
    el.innerHTML = '<div class="empty"><div class="empty-icon">üß¨</div>No resolved trades yet ‚Äî breakdown appears after positions close</div>';
    return;
  }
  const pnlSeries = (archPnlRes && archPnlRes.series) || {};
  const maxTrades = Math.max(...items.map(a => a.trades));
  el.innerHTML = `<table class="arch-table">
    <thead><tr><th>Archetype</th><th>Trades</th><th>Win Rate</th><th>P&L</th><th>ROI</th><th>Avg Hold</th><th>Trend</th><th></th></tr></thead>
    <tbody>${items.map(a => {
      const barColor = a.pnl >= 0 ? 'var(--green)' : 'var(--red)';
      const barWidth = Math.max(10, (a.trades / maxTrades) * 100);
      const hasSparkline = pnlSeries[a.archetype] && pnlSeries[a.archetype].length >= 2;
      return `<tr>
        <td class="arch-name">${a.archetype}</td>
        <td class="mono">${a.trades}</td>
        <td class="mono ${a.win_rate >= 50 ? 'green' : 'red'}">${a.win_rate}%</td>
        <td class="mono ${a.pnl >= 0 ? 'result-won' : 'result-lost'}">${a.pnl >= 0 ? '+' : ''}$${a.pnl.toFixed(2)}</td>
        <td class="mono ${a.roi >= 0 ? 'green' : 'red'}">${a.roi >= 0 ? '+' : ''}${a.roi}%</td>
        <td class="mono">${a.avg_hold_days}d</td>
        <td>${hasSparkline ? `<canvas class="arch-spark" data-arch="${a.archetype}"></canvas>` : '‚Äî'}</td>
        <td><div class="arch-bar" style="width:100px"><div class="arch-bar-fill" style="width:${barWidth}%;background:${barColor}"></div></div></td>
      </tr>`;
    }).join('')}</tbody>
  </table>`;

  // Draw sparklines on canvases
  el.querySelectorAll('canvas.arch-spark').forEach(canvas => {
    const arch = canvas.dataset.arch;
    const series = pnlSeries[arch] || [];
    if (series.length < 2) return;
    const values = series.map(s => s.cumulative_pnl);
    const ctx = canvas.getContext('2d');
    const w = canvas.width = 80;
    const h = canvas.height = 24;
    const min = Math.min(0, ...values);
    const max = Math.max(0, ...values);
    const range = max - min || 1;
    const final = values[values.length - 1];
    const color = final >= 0 ? '#00e676' : '#ff5252';

    ctx.clearRect(0, 0, w, h);
    // Zero line
    const zeroY = h - ((0 - min) / range) * (h - 4) - 2;
    ctx.strokeStyle = 'rgba(136,136,160,0.3)';
    ctx.lineWidth = 0.5;
    ctx.beginPath();
    ctx.moveTo(0, zeroY);
    ctx.lineTo(w, zeroY);
    ctx.stroke();
    // Sparkline
    ctx.strokeStyle = color;
    ctx.lineWidth = 1.5;
    ctx.beginPath();
    values.forEach((v, i) => {
      const x = (i / (values.length - 1)) * w;
      const y = h - ((v - min) / range) * (h - 4) - 2;
      i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
    });
    ctx.stroke();
    // End dot
    const lastX = w;
    const lastY = h - ((final - min) / range) * (h - 4) - 2;
    ctx.fillStyle = color;
    ctx.beginPath();
    ctx.arc(lastX - 1, lastY, 2, 0, Math.PI * 2);
    ctx.fill();
  });
}

function renderResolveLog(resolveLogRes) {
  const el = document.getElementById('resolveLog');
  const items = Array.isArray(resolveLogRes) ? resolveLogRes : [];
  document.getElementById('resolveCount').textContent = `${items.length} recent`;
  if (!items.length) {
    el.innerHTML = '<div class="empty"><div class="empty-icon">üîÑ</div>No resolutions yet</div>';
    return;
  }
  el.innerHTML = items.map(r => {
    const pnl = r.pnl || 0;
    const ts = r.closed_at ? new Date(r.closed_at) : null;
    const timeStr = ts ? `${ts.getMonth()+1}/${ts.getDate()} ${ts.getHours()}:${String(ts.getMinutes()).padStart(2,'0')}` : '‚Äî';
    const outcome = r.status === 'won' ? '‚úÖ' : '‚ùå';
    const reason = r.close_reason || 'auto-resolved';
    return `<div class="resolve-row">
      <span class="resolve-time">${timeStr}</span>
      <span>${outcome}</span>
      <span class="resolve-market">${(r.market_title || '').substring(0, 60)}</span>
      <span class="mono ${pnl >= 0 ? 'green' : 'red'}">${pnl >= 0 ? '+' : ''}$${pnl.toFixed(2)}</span>
      <span style="font-size:10px;color:var(--text2)">${reason}</span>
    </div>`;
  }).join('');
}

async function processSignals() {
  const btn = document.getElementById('processBtn');
  const msg = document.getElementById('statusMsg');
  btn.disabled = true;
  msg.textContent = '‚ö° Processing signals...';

  try {
    const res = await fetch(`${API}/portfolio/process-signals`, { method: 'POST' }).then(r => r.json());
    const opened = res.opened || 0;
    const processed = res.processed || 0;
    const skipped = res.skipped || 0;
    // Count kill reasons
    const signals = res.signals || res.results || [];
    const killed = signals.filter(s => (s.reason || '').startsWith('Kill rule')).length;
    const lowEdge = signals.filter(s => (s.reason || '').includes('Edge')).length;
    const lowConf = signals.filter(s => (s.reason || '').includes('Confidence')).length;
    msg.textContent = `‚úÖ ${processed} scanned ¬∑ ${opened} opened ¬∑ ${killed} killed ¬∑ ${skipped - killed} filtered`;
    renderSignals(signals);
    setTimeout(loadAll, 500);
  } catch(e) {
    msg.textContent = '‚ùå Error: ' + e.message;
  }
  btn.disabled = false;
}

function renderSignals(signals) {
  const el = document.getElementById('recentSignals');
  document.getElementById('signalCount').textContent = `${signals.length} evaluated`;
  if (!signals.length) {
    el.innerHTML = '<div class="empty"><div class="empty-icon">üì°</div>No signals in latest scan</div>';
    return;
  }
  el.innerHTML = signals.map(s => {
    const edge = (s.edge || s.edge_pct || 0);
    const edgePct = (edge * 100).toFixed(1);
    const isGood = edge >= 0.05;
    const action = s.action || s.status || 'skipped';
    const isOpened = action === 'opened' || action === 'traded';
    const reason = s.reason || 'skipped';
    const isKilled = reason.startsWith('Kill rule');
    return `<div class="signal-row">
      <span class="badge badge-${(s.side||'no').toLowerCase()}" style="margin-right:8px">${s.side || '?'}</span>
      <div class="signal-market">${(s.market || s.title || '').substring(0, 60)}</div>
      <span class="signal-edge ${isGood ? 'good' : 'low'}">${edgePct}% edge</span>
      <span class="signal-action ${isOpened ? 'opened' : 'skipped'}" ${isKilled ? 'style="color:var(--orange)"' : ''}>
        ${isOpened ? `‚úÖ $${(s.bet_size || 0).toFixed(0)}` : `‚äò ${reason.substring(0, 40)}`}
      </span>
    </div>`;
  }).join('');
}

// Init
loadAll();
setInterval(loadAll, 60000);
</script>
</body>
</html>
